generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  OWNER
  ADMIN
  MEMBER
}

enum OpportunityStatus {
  OPEN
  WON
  LOST
}

enum ActivityType {
  NOTE
  CALL
  SMS
  EMAIL
  TASK
}

enum MessageChannel {
  SMS
  EMAIL
}

enum MessageDirection {
  IN
  OUT
}

enum WorkflowStepStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  SKIPPED
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  passwordHash   String?
  name           String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  memberships    WorkspaceMember[]
  refreshTokens  RefreshToken[]
  magicLinks     MagicLinkToken[]
}

model Workspace {
  id          String   @id @default(cuid())
  name        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  members     WorkspaceMember[]
  contacts    Contact[]
  pipelines   Pipeline[]
  stages      Stage[]
  opportunities Opportunity[]
  activities  Activity[]
  threads     MessageThread[]
  messages    Message[]
  templates   Template[]
  forms       Form[]
  submissions FormSubmission[]
  automations Automation[]
  workflowRuns WorkflowRun[]
  auditLogs   AutomationAuditLog[]
}

model WorkspaceMember {
  id          String   @id @default(cuid())
  userId      String
  workspaceId String
  role        Role
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id])
  workspace   Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([userId, workspaceId])
  @@index([workspaceId])
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model MagicLinkToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model Contact {
  id          String   @id @default(cuid())
  workspaceId String
  firstName   String?
  lastName    String?
  phone       String?
  email       String?
  tags        String[]
  customFields Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  opportunities Opportunity[]
  activities  Activity[]
  threads     MessageThread[]

  @@index([workspaceId])
  @@index([workspaceId, email])
  @@index([workspaceId, phone])
}

model Pipeline {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  stages      Stage[]

  @@index([workspaceId])
}

model Stage {
  id          String   @id @default(cuid())
  workspaceId String
  pipelineId  String
  name        String
  order       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  pipeline    Pipeline @relation(fields: [pipelineId], references: [id])
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  opportunities Opportunity[]

  @@index([workspaceId])
  @@index([pipelineId])
}

model Opportunity {
  id          String   @id @default(cuid())
  workspaceId String
  contactId   String
  stageId     String
  value       Int?
  status      OpportunityStatus @default(OPEN)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  contact     Contact @relation(fields: [contactId], references: [id])
  stage       Stage   @relation(fields: [stageId], references: [id])
  workspace   Workspace @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId])
  @@index([stageId])
}

model Activity {
  id          String   @id @default(cuid())
  workspaceId String
  contactId   String?
  opportunityId String?
  type        ActivityType
  body        String
  status      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  contact     Contact? @relation(fields: [contactId], references: [id])
  opportunity Opportunity? @relation(fields: [opportunityId], references: [id])

  @@index([workspaceId])
  @@index([contactId])
}

model MessageThread {
  id          String   @id @default(cuid())
  workspaceId String
  contactId   String
  channel     MessageChannel
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  contact     Contact @relation(fields: [contactId], references: [id])
  messages    Message[]

  @@index([workspaceId])
  @@index([contactId])
}

model Message {
  id          String   @id @default(cuid())
  workspaceId String
  threadId    String
  channel     MessageChannel
  direction   MessageDirection
  status      String
  body        String
  providerId  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  thread      MessageThread @relation(fields: [threadId], references: [id])

  @@index([workspaceId])
  @@index([threadId])
}

model Template {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  channel     MessageChannel
  subject     String?
  body        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId])
}

model Form {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  fields      Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  submissions FormSubmission[]

  @@index([workspaceId])
}

model FormSubmission {
  id          String   @id @default(cuid())
  workspaceId String
  formId      String
  payload     Json
  createdAt   DateTime @default(now())
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  form        Form @relation(fields: [formId], references: [id])

  @@index([workspaceId])
  @@index([formId])
}

model Automation {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  enabled     Boolean @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  triggers    Trigger[]
  actions     Action[]
  workflowRuns WorkflowRun[]

  @@index([workspaceId])
}

model Trigger {
  id          String   @id @default(cuid())
  workspaceId String
  automationId String
  type        String
  config      Json
  createdAt   DateTime @default(now())
  automation  Automation @relation(fields: [automationId], references: [id])
  workspace   Workspace @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId])
}

model Action {
  id          String   @id @default(cuid())
  workspaceId String
  automationId String
  type        String
  order       Int
  config      Json
  createdAt   DateTime @default(now())
  automation  Automation @relation(fields: [automationId], references: [id])
  workspace   Workspace @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId])
}

model WorkflowRun {
  id            String   @id @default(cuid())
  workspaceId   String
  automationId  String
  triggerEvent  String
  triggerPayload Json
  status        String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  automation    Automation @relation(fields: [automationId], references: [id])
  workspace     Workspace @relation(fields: [workspaceId], references: [id])
  steps         WorkflowStepRun[]

  @@index([workspaceId])
}

model WorkflowStepRun {
  id            String   @id @default(cuid())
  workflowRunId String
  workspaceId   String
  actionId      String
  status        WorkflowStepStatus @default(PENDING)
  startedAt     DateTime?
  completedAt   DateTime?
  output        Json?
  idempotencyKey String
  createdAt     DateTime @default(now())
  workflowRun   WorkflowRun @relation(fields: [workflowRunId], references: [id])
  workspace     Workspace @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId])
  @@index([workflowRunId])
  @@unique([workspaceId, idempotencyKey])
}

model AutomationAuditLog {
  id            String   @id @default(cuid())
  workspaceId   String
  automationId  String
  event         String
  payload       Json
  createdAt     DateTime @default(now())
  workspace     Workspace @relation(fields: [workspaceId], references: [id])
  automation    Automation @relation(fields: [automationId], references: [id])

  @@index([workspaceId])
}
